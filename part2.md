# Is it Observable?
<p align="center"><img src="/image/logo.png" width="40%" alt="Prometheus Logo" /></p>

##  How to observe a Ngninx ingress controller?
### Part 2 using Loki and Logql
<p align="center"><img src="/image/loki_logo.png" width="40%" alt="Loki Logo" /></p>
Repository containing the files for the Episode 11 of Is it Observable : Observability of Nginx Controller using Loki


THis tutorial will reuse the steps describe in the Part 1 of our Tutorial.
Make sure to deploy :
- Nginx Ingress controller
- Prometheus Operator
- Configure the ingress controller for Grafana and the Google Hipster Shop
- Deploy the Google hipster Shop

### 1. Configure the ngninx controller
To generate logs containing extended information related to our ingress controller we need to update the configuration of ngninx to explose more logs.
let's modify the configmap to enhance the login format
```
kubectl edit cm nginx-config
```
add the following line:
```yaml
data:
  log_format: $remote_addr [$time_local] $request $status $body_bytes_sent $request_time $upstream_addr $upstream_response_time $proxy_host $upstream_status $resource_name $resource_type $resource_namespace $service
```

### 2. Install Loki
#### Install Loki with Promtail
```
helm repo add grafana https://grafana.github.io/helm-charts
helm repo update
helm upgrade --install loki grafana/loki-stack
```
#### Configure Grafana
In order to build a dashboard with data stored in Loki,we first need to add a new DataSource.
In grafana, goto Configuration/Add data source.
<p align="center"><img src="/image/addsource.PNG" width="60%" alt="grafana add datasource" /></p>
Select the source Loki , and configure the url to interact with it.

Remember Grafana is hosted in the same namesapce as Loki.
So you can simply refer the loki service :
<p align="center"><img src="/image/datasource.PNG" width="60%" alt="grafana add datasource" /></p>


### 3. Update the Grafana dashboard

#### explore the data provided by Loki in Grafana
In grafana select Explore on the main menu
Select the datasource Loki . IN the dropdow menu select the label produc -> hipster-shop
<p align="center"><img src="/image/explore.png" width="60%" alt="grafana explore" /></p>

#### Let's build a query

##### Stream selector 
The first step when using a LogQL is to filter the log stream on Nginx :
```
{app="ngninx-nginx-ingress",namespace="default"}
```

##### Line Filter
To only look at the log stream generated by traffic going through our ingress we could add a the following line filter:
```
{app="ngninx-nginx-ingress",namespace="default"}
|="ingress" !="stderr"
```
##### Parser
By defining a specif log format of our Nginx Ingress controller it would be easy to parse our log file using Pattern :
```
{app="ngninx-nginx-ingress",namespace="default"}
|="ingress" !="stderr"
| pattern `<remote_addr> [<time_local>] <method> <request> <_> <status> <body_bytes_sent> <request_time> <_> <upstream_response_time> <_>  <status_ingress> <resource_name> <_> <namespace_patter> <service>`
```
##### Label Filter
By using a Parser our log pipeline has now new labels add by the Pattern function. we can now add extra filters based on our new labels
```
{app="ngninx-nginx-ingress",namespace="default"}
|="ingress" !="stderr"
| pattern `<remote_addr> [<time_local>] <method> <request> <_> <status> <body_bytes_sent> <request_time> <_> <upstream_response_time> <_>  <status_ingress> <resource_name> <_> <namespace_patter> <service>`
| status<400 and method="GET"
```
#### Let's create a dashboard
##### Number of http request per ingress
```
count by (service) ( rate(
{app="ngninx-nginx-ingress",pod="ngninx-nginx-ingress-7b95f794c4-kv5rb"}
|="ingress" !="stderr"
| pattern `<remote_addr> [<time_local>] <method> <request> <_> <status> <body_bytes_sent> <request_time> <_> <upstream_response_time> <_>  <status_ingress> <resource_name> <_> <namespace_patter> <service>`
[1m]))
```
##### Amount of bytes per services
```
sum by (service) ( sum_over_time( {app="ngninx-nginx-ingress",pod="ngninx-nginx-ingress-7b95f794c4-kv5rb"}
|="ingress" !="stderr"
| pattern `<remote_addr> [<time_local>] <method> <request> <_> <status> <body_bytes_sent> <request_time> <_> <upstream_response_time> <_>  <status_ingress> <resource_name> <_> <namespace_patter> <service>`
| unwrap body_bytes_sent[1m])
)
```
##### P99 Resonse time per service
```
quantile_over_time(0.99,
{app="ngninx-nginx-ingress",pod="ngninx-nginx-ingress-7b95f794c4-kv5rb"}
|="ingress" !="stderr"
| pattern `<remote_addr> [<time_local>] <method> <request> <_> <status> <body_bytes_sent> <request_time> <_> <upstream_response_time> <_>  <status_ingress> <resource_name> <_> <namespace_patter> <service>`
| status<400
| unwrap request_time[1m]) by (service)
```

